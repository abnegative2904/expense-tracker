<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Expense Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        margin: 0;
        padding: 0;
        text-align: center;
    }
    header {
        background: #4CAF50;
        color: white;
        padding: 15px;
        font-size: 24px;
        font-weight: bold;
    }
    .container {
        max-width: 900px;
        margin: 20px auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    form {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
    }
    input, select, textarea, button {
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    button {
        background: #4CAF50;
        color: white;
        cursor: pointer;
    }
    button:hover {
        background: #45a049;
    }
    ul {
        list-style: none;
        padding: 0;
    }
    li {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }
    .summary {
        margin: 15px 0;
        padding: 10px;
        background: #eee;
        border-radius: 5px;
    }
    .alert {
        padding: 10px;
        margin: 10px auto;
        font-weight: bold;
        width: fit-content;
    }
    .green { background: #c8f7c5; color: #2d6a4f; }
    .red { background: #f8d7da; color: #842029; }
    .month-selector {
        margin-bottom: 15px;
    }
    footer {
        margin-top: 30px;
        padding: 15px;
        background: #222;
        color: white;
        font-size: 14px;
        border-radius: 0 0 8px 8px;
    }
</style>
</head>
<body>

<header>Welcome Abhishek â€” Your Expense Tracker</header>

<div class="container">
    <div class="summary">
        <p><strong>Monthly Limit:</strong> â‚¹<span id="limit">0</span></p>
        <p><strong>Days Left in Month:</strong> <span id="days-left"></span></p>
        <p><strong>Total Spent:</strong> â‚¹<span id="total-spent">0</span></p>
    </div>

    <form id="limit-form">
        <input type="number" id="set-limit" placeholder="Set Monthly Limit (â‚¹)" required>
        <button type="submit">Set Limit</button>
    </form>

    <form id="expense-form">
        <input type="text" id="name" placeholder="Expense Name" required>
        <input type="number" id="amount" placeholder="Amount (â‚¹)" required>
        <select id="expense_type" required>
            <option value="">Select Expense Type</option>
            <option>Paid Mess</option>
            <option>Bus</option>
            <option>OAC</option>
            <option>Bissu</option>
            <option>Jai Udhaar</option>
            <option>Gym</option>
            <option>Bhabhi</option>
            <option>Other</option>
        </select>
        <textarea id="note" placeholder="Note (optional)"></textarea>
        <button type="submit">Add Expense</button>
    </form>

    <div id="message" class="alert"></div>

    <div class="month-selector">
        <label for="monthFilter"><strong>View by Month:</strong></label>
        <select id="monthFilter"></select>
    </div>

    <h3>Expense List</h3>
    <ul id="expense-list"></ul>

    <h3>Spending Breakdown</h3>
    <canvas id="pieChart"></canvas>
</div>

<footer>
    <p>All rights reserved â€” Abhishek</p>
    <p>Contact: <a href="mailto:a2004shek@gmail.com" style="color:#4CAF50;">a2004shek@gmail.com</a></p>
</footer>

<script>
    let expenses = [];
    let monthlyLimit = 0;

    const expenseList = document.getElementById('expense-list');
    const totalSpentEl = document.getElementById('total-spent');
    const limitEl = document.getElementById('limit');
    const messageEl = document.getElementById('message');
    const daysLeftEl = document.getElementById('days-left');
    const monthFilterEl = document.getElementById('monthFilter');

    function updateDaysLeft() {
        const today = new Date();
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        daysLeftEl.textContent = Math.ceil((lastDay - today) / (1000 * 60 * 60 * 24));
    }
    updateDaysLeft();

    let pieChart;
    function updateChart(filteredExpenses) {
        const categoryTotals = {};
        filteredExpenses.forEach(e => {
            if (!categoryTotals[e.expense_type]) categoryTotals[e.expense_type] = 0;
            categoryTotals[e.expense_type] += parseFloat(e.amount);
        });

        const ctx = document.getElementById('pieChart').getContext('2d');
        if (pieChart) pieChart.destroy();
        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(categoryTotals),
                datasets: [{
                    data: Object.values(categoryTotals),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56',
                        '#4BC0C0', '#9966FF', '#FF9F40', '#6f42c1', '#20c997'
                    ]
                }]
            }
        });
    }

    function populateMonthFilter() {
        const months = [...new Set(expenses.map(e => {
            const date = new Date(e.expense_date);
            return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
        }))];
        monthFilterEl.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
        monthFilterEl.value = months[0] || '';
    }

    function renderExpenses() {
        const selectedMonth = monthFilterEl.value;
        const filteredExpenses = expenses.filter(e => {
            const date = new Date(e.expense_date);
            const ym = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`;
            return selectedMonth ? ym === selectedMonth : true;
        });

        expenseList.innerHTML = '';
        const totalSpent = filteredExpenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
        totalSpentEl.textContent = totalSpent.toFixed(2);
        limitEl.textContent = monthlyLimit;

        if (monthlyLimit > 0) {
            if (totalSpent < monthlyLimit * 0.5) {
                messageEl.textContent = "Dad can chill now ðŸ˜Ž";
                messageEl.className = "alert green";
            } else if (totalSpent < monthlyLimit) {
                messageEl.textContent = "Spending okay, keep track ðŸ‘€";
                messageEl.className = "alert";
            } else {
                messageEl.textContent = "Time to call Dad ðŸ“žðŸ’¸";
                messageEl.className = "alert red";
            }
        }

        filteredExpenses.forEach(e => {
            const li = document.createElement('li');
            li.textContent = `${e.name} â€” â‚¹${e.amount} (${e.expense_type}) ${e.note ? 'â€” ' + e.note : ''}`;
            expenseList.appendChild(li);
        });

        updateChart(filteredExpenses);
    }

    async function fetchExpenses() {
        const res = await fetch('/expenses');
        const data = await res.json();
        expenses = data;
        populateMonthFilter();
        renderExpenses();
    }

    document.getElementById('expense-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = document.getElementById('name').value;
        const amount = document.getElementById('amount').value;
        const expense_type = document.getElementById('expense_type').value;
        const note = document.getElementById('note').value;

        await fetch('/expenses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, amount, expense_type, note })
        });

        this.reset();
        fetchExpenses();
    });

    document.getElementById('limit-form').addEventListener('submit', function(e) {
        e.preventDefault();
        monthlyLimit = parseFloat(document.getElementById('set-limit').value);
        localStorage.setItem('monthlyLimit', monthlyLimit);
        renderExpenses();
    });

    monthFilterEl.addEventListener('change', renderExpenses);

    monthlyLimit = parseFloat(localStorage.getItem('monthlyLimit')) || 0;
    fetchExpenses();
</script>

</body>
</html>

