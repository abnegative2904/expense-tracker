<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Abhishek — Expense Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#fff8e1; --panel:#fff; --accent:#ffd54f; --accent-dark:#f57f17; --muted:#666;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111;-webkit-font-smoothing:antialiased}
  header{background:var(--accent);color:#111;padding:16px;text-align:center}
  header h1{margin:0;font-size:1.12rem;font-weight:700}
  header .sub{margin-top:6px;font-size:0.95rem;color:#111}
  .container{max-width:920px;margin:18px auto;padding:18px;background:var(--panel);border-radius:10px;box-shadow:0 6px 22px rgba(0,0,0,.06)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .col{flex:1;min-width:220px}
  label{display:block;font-size:0.85rem;color:var(--muted);margin-bottom:6px}
  input[type=number], select, input[type=text], textarea, button {
    width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(0,0,0,.08);font-size:1rem;
  }
  textarea{min-height:44px;resize:vertical}
  button{background:var(--accent-dark);color:#fff;border:none;cursor:pointer;padding:10px 12px;font-weight:600}
  .section{margin-top:14px}
  .summary{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
  .summary .box{background:#fff8e6;border:1px solid rgba(0,0,0,.03);padding:10px 12px;border-radius:8px;min-width:140px}
  .progress-wrap{width:100%;background:#fff3cd;border-radius:999px;height:18px;overflow:hidden;border:1px solid rgba(0,0,0,.03)}
  .progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent-dark),#ffb300);transition:width .3s ease}
  #message{margin:10px auto;font-weight:700;padding:8px;border-radius:8px;display:inline-block}
  .msg-chill{background:#fff9c4;color:#7a5a00}
  .msg-over{background:#ffe6e6;color:#861212}
  .history{margin-top:12px;text-align:left}
  #expense-list{list-style:none;padding:0;margin:8px 0 0}
  #expense-list li{padding:8px;border-bottom:1px solid rgba(0,0,0,.04);font-size:0.97rem}
  footer{margin-top:18px;padding:14px;text-align:center;background:#111;color:#fff;border-radius:0 0 10px 10px}
  .call-btn{background:#d84315;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;display:inline-block}
  /* Top controls (call + limit) */
  .top-controls{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:12px}
  .limit-row{display:flex;gap:8px;align-items:center;justify-content:flex-start}
  .limit-row input{max-width:180px}
  .limit-row button{max-width:120px}
  /* Make Add Expense the visible focus */
  #expenseForm{background:linear-gradient(180deg,#fff,#fffaf0);padding:18px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.06);max-width:760px;margin:16px auto}
  #expenseForm .col{min-width:140px}
  @media (max-width:600px){
    header h1{font-size:1rem}
    .container{padding:12px}
    .limit-row{justify-content:flex-start}
  }
</style>
</head>
<body>
  <header>
    <h1>Welcome Abhishek — Your Expense Tracker</h1>
    <div class="sub">Personalized</div>
  </header>

  <div class="container">
    <!-- SUMMARY -->
    <div class="summary section">
      <div class="box">
        <div style="font-size:.8rem;color:#555">Monthly limit</div>
        <div id="limitValue" style="font-size:1.05rem;font-weight:700">₹0.00</div>
      </div>
      <div class="box">
        <div style="font-size:.8rem;color:#555">Days left</div>
        <div id="daysLeft" style="font-size:1.05rem;font-weight:700">0</div>
      </div>
      <div class="box">
        <div style="font-size:.8rem;color:#555">Total spent</div>
        <div id="totalSpent" style="font-size:1.05rem;font-weight:700">₹0.00</div>
      </div>
    </div>

    <!-- progress & message -->
    <div class="section" style="text-align:center;margin-top:12px">
      <div class="progress-wrap" aria-hidden="true">
        <div id="progressBar" class="progress-bar" style="width:0%"></div>
      </div>
      <div id="message" style="margin-top:10px"></div>
    </div>

    <!-- TOP CONTROLS: Call dad (top) + limit controls (left-aligned) -->
    <div class="top-controls section">
      <div id="topCallArea" style="display:none">
        <a id="topCallBtn" class="call-btn" href="tel:8340262841">Call Dad </a>
      </div>

      <div class="limit-row" style="flex:1;">
        <input id="setLimit" type="number" placeholder="Set monthly limit (₹)">
        <button id="saveLimit">Save Limit</button>
      </div>
    </div>

    <!-- ADD EXPENSE (centered focus) -->
    <div class="section">
      <form id="expenseForm" class="row" style="justify-content:center">
        <div class="col" style="max-width:260px">
          <label>Expense Type</label>
          <select id="expenseType" required>
            <option value="">Select Type</option>
            <option>Paid Mess</option>
            <option>Cab</option>
            <option>Bus</option>
            <option>Bissu</option>
            <option>OAC</option>
            <option>FC</option>
            <option>Jai Udhaar</option>
            <option>Gym</option>
            <option>Minoxidil</option>
            <option>Blinkit</option>
            <option>Bhabhi</option>
            <option>Other</option>
          </select>
        </div>

        <div class="col" style="max-width:220px">
          <label>Amount (₹)</label>
          <input id="amountInput" type="number" step="0.01" required placeholder="e.g. 120.50">
        </div>

        <div class="col" style="max-width:420px">
          <label>Note (optional)</label>
          <input id="noteInput" type="text" placeholder="Short note">
        </div>

        <div style="width:100%;text-align:center;margin-top:10px">
          <button type="submit" style="max-width:260px">Add Expense</button>
        </div>
      </form>
    </div>

    <!-- history & filter -->
    <div class="section history">
      <label style="display:block;margin-bottom:8px"><strong>View by month</strong></label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <select id="monthSelect" style="max-width:220px"></select>
        <button id="refreshBtn">Refresh</button>
      </div>

      <ul id="expense-list"></ul>
    </div>

    <!-- chart -->
    <div class="section" style="text-align:center">
      <h3 style="margin-bottom:6px">Expense breakdown</h3>
      <canvas id="pie" style="max-width:420px;margin:auto"></canvas>
    </div>

  </div>

  <footer>
    <div>All rights reserved — Abhishek</div>
    <div>Contact: <a href="mailto:a2004shek@gmail.com" style="color:#ffd54f">a2004shek@gmail.com</a></div>
  </footer>

<script>
(async function(){
  // endpoints
  const EXPENSES_URL = '/expenses';
  const LIMIT_URL = '/limit';

  // DOM
  const monthSelect = document.getElementById('monthSelect');
  const expenseList = document.getElementById('expense-list');
  const amountInput = document.getElementById('amountInput');
  const typeSelect = document.getElementById('expenseType');
  const noteInput = document.getElementById('noteInput');
  const setLimitInput = document.getElementById('setLimit');
  const saveLimitBtn = document.getElementById('saveLimit');
  const refreshBtn = document.getElementById('refreshBtn');
  const totalSpentEl = document.getElementById('totalSpent');
  const limitValueEl = document.getElementById('limitValue');
  const daysLeftEl = document.getElementById('daysLeft');
  const progressBar = document.getElementById('progressBar');
  const messageEl = document.getElementById('message');
  const topCallArea = document.getElementById('topCallArea');
  const topCallBtn = document.getElementById('topCallBtn');
  const pieCtx = document.getElementById('pie').getContext('2d');

  let expenses = [];
  let currentLimit = 0;
  let pieChart = null;

  function formatMonthYYYYMM(d){
    return d.toISOString().slice(0,7);
  }
  function formatMonthLabel(d){
    return d.toLocaleString('default',{ month:'long', year:'numeric' });
  }
  function daysLeftThisMonth(){
    const today = new Date();
    const last = new Date(today.getFullYear(), today.getMonth()+1, 0);
    return Math.ceil((last - today) / (1000*60*60*24));
  }

  // populate monthSelect (last 12 months + 'All')
  function populateMonths(){
    monthSelect.innerHTML = '';
    const allOpt = document.createElement('option');
    allOpt.value = '';
    allOpt.textContent = 'All months';
    monthSelect.appendChild(allOpt);

    const now = new Date();
    for(let i=0;i<12;i++){
      const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
      const opt = document.createElement('option');
      opt.value = formatMonthYYYYMM(d);
      opt.textContent = formatMonthLabel(d);
      monthSelect.appendChild(opt);
    }
    monthSelect.value = formatMonthYYYYMM(new Date());
  }

  populateMonths();
  daysLeftEl.textContent = daysLeftThisMonth();

  // fetch limit for current month
  async function fetchLimit(){
    try{
      const res = await fetch(LIMIT_URL);
      if(!res.ok) throw new Error('Limit fetch failed');
      const json = await res.json();
      currentLimit = parseFloat(json.limit_amount) || 0;
      limitValueEl.textContent = `₹${currentLimit.toFixed(2)}`;
      setLimitInput.value = currentLimit ? currentLimit : '';
    }catch(err){
      console.error('fetchLimit',err);
      currentLimit = 0;
      limitValueEl.textContent = '₹0.00';
    }
  }

  // set/update limit
  saveLimitBtn.addEventListener('click', async () => {
    const val = parseFloat(setLimitInput.value);
    if(isNaN(val) || val < 0) return alert('Enter a valid limit');
    try{
      const res = await fetch(LIMIT_URL, {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ limit_amount: val })
      });
      if(!res.ok) throw new Error('Failed to save limit');
      await fetchLimit();
      await loadExpenses(); // re-evaluate progress
    }catch(err){
      console.error(err);
      alert('Could not save limit');
    }
  });

  // load expenses (optionally filtered by month)
  async function loadExpenses(month){
    try{
      const q = month ? '?month=' + encodeURIComponent(month) : '';
      const res = await fetch(EXPENSES_URL + q);
      if(!res.ok) throw new Error('Failed to fetch expenses');
      expenses = await res.json();
      renderExpenses();
      renderChart();
    }catch(err){
      console.error('loadExpenses',err);
      expenses = [];
      renderExpenses();
      renderChart();
    }
  }

  function renderExpenses(){
    expenseList.innerHTML = '';
    const selectedMonth = monthSelect.value;
    const filtered = expenses.filter(e => {
      if(!selectedMonth) return true;
      return (e.expense_date && e.expense_date.slice(0,7) === selectedMonth);
    });

    filtered.sort((a,b)=> (b.expense_date || '').localeCompare(a.expense_date || '') );

    let total = 0;
    filtered.forEach(row => {
      total += parseFloat(row.amount || 0);
      const li = document.createElement('li');
      const date = row.expense_date ? new Date(row.expense_date).toLocaleDateString() : '';
      li.textContent = `${date} • ₹${parseFloat(row.amount).toFixed(2)} • ${row.expense_type} ${row.note ? '— ' + row.note : ''}`;
      expenseList.appendChild(li);
    });

    totalSpentEl.textContent = `₹${total.toFixed(2)}`;

    // progress & messages
    const pct = (currentLimit > 0) ? Math.min((total / currentLimit) * 100, 100) : 0;
    progressBar.style.width = pct + '%';

    if(currentLimit > 0){
      if(total < currentLimit){
        messageEl.textContent = 'Dad can chill now 😎';
        messageEl.className = 'msg-chill';
        topCallArea.style.display = 'none';
      } else {
        messageEl.textContent = 'Time to call Dad — limit exceeded!';
        messageEl.className = 'msg-over';
        topCallArea.style.display = 'block';
      }
    } else {
      messageEl.textContent = 'Monthly limit not set';
      messageEl.className = '';
      topCallArea.style.display = 'none';
    }
  }

  function renderChart(){
    const selectedMonth = monthSelect.value;
    const filtered = expenses.filter(e => {
      if(!selectedMonth) return true;
      return (e.expense_date && e.expense_date.slice(0,7) === selectedMonth);
    });

    const totals = {};
    filtered.forEach(e=>{
      totals[e.expense_type] = (totals[e.expense_type] || 0) + parseFloat(e.amount || 0);
    });

    const labels = Object.keys(totals);
    const data = Object.values(totals);

    if(pieChart) pieChart.destroy();
    pieChart = new Chart(pieCtx, {
      type:'pie',
      data:{
        labels,
        datasets:[{
          data,
          backgroundColor: ['#f57f17','#ffd54f','#ffb300','#ff8f00','#fb8c00','#ffab91','#ff7043','#ffcc80','#ffd180','#ffecb3']
        }]
      },
      options:{plugins:{legend:{position:'bottom'}},maintainAspectRatio:true}
    });
  }

  // add expense
  document.getElementById('expenseForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const amount = parseFloat(amountInput.value);
    const expense_type = typeSelect.value;
    const note = noteInput.value || null;
    if(!expense_type || !amount || amount <= 0) return alert('Select type and enter a positive amount');

    try{
      const res = await fetch(EXPENSES_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ amount, expense_type, note })
      });
      if(!res.ok) throw new Error('Insert failed');
      amountInput.value = '';
      typeSelect.value = '';
      noteInput.value = '';
      await fetchLimit();
      await loadExpenses(monthSelect.value);
    }catch(err){
      console.error('add expense',err);
      alert('Failed to add expense');
    }
  });

  monthSelect.addEventListener('change', ()=> loadExpenses(monthSelect.value));
  refreshBtn.addEventListener('click', ()=> loadExpenses(monthSelect.value));

  // initialize
  await fetchLimit();
  await loadExpenses(monthSelect.value);
})();
</script>
</body>
</html>
